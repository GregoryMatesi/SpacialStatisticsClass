---
title: "hw3"
output: 
    pdf_document :
      latex_engine : xelatex
---

# Problem 1

The *Urkiola* data set in the **spatstat** package contains locations of birch (*Betula celtiberica*) and oak (*Quercus robur*) trees in a secondary wood in Urkiola NAtural Park (Basque country, Northern Spain). They are part of a more extensive dataset collected and analysed by Laskurain (2008). The coordinates of the trees are given in meters. Let the "oak" trees be the cases and birch trees be the controls.

## part a

**Create a plot of the point pattern that distinguishes between the two types of trees. Do you notice any evidence of clusters? Explain.**

```{r}
setwd("/d")
set.seed(1)
library(spatstat)
library(smacpod)

data("urkiola")
str(urkiola)
class.urkiola <- class(urkiola)
```

The *urkiola* data is already a `r class.urkiola` class object.

```{r}
rm(class.urkiola)
oak <- which(urkiola$marks == "oak")
#birch <- which(urkiola$marks == "birch")
```

```{r}
oakbw <- bw.scott(urkiola[oak,])
birchbwd <- bw.scott(urkiola[-oak,])

oakbw
birchbwd
```


```{r}
# estimate densities of cases and controls, respectively,
# using bandwidth of 700
f.density = spdensity(urkiola[oak, ], sigma = oakbw)
g.density = spdensity(urkiola[-oak,], sigma = birchbwd)
```

```{r}
# contour plot of f700 with title
contour(f.density, nlevels = 15, main = "")
title("Affected, bandwidth = 700")
# contour plot of g700, with title
contour(g.density, nlevels = 15, main = "")
title("Nonaffected, bandwidth = 700")
```

```{r}
# log ratio of spatial densities
r700 = logrr(urkiola, case = 2, sigma = 15)
r700


#contour plot of r700 (lty and lwd determined
# by experimentation)
contour(r700, lty = c(1, 1, 1, 1, 2, 1),
        lwd = c(1, 1, 1, 1, 1, 2), main = "")
title("Gaussian kernel, Bandwidth = 700")
```

```{r}
# calculate log ratio of spatial densities for bandwidth = 350
f.145 = spdensity(urkiola[oak, ], sigma = 14.5)
g.15 = spdensity(urkiola[-oak,], sigma = 15)
r350 = logrr(urkiola, case = 2)
# contour plot of log ratio of spatial densities
contour(r350, lty = c(2, 1, 1, 1, 1), main = "")

```

```{r}
# construct 95% tolerance envelopes for log relative risk
# when bandwidth = 350

urkiola_renv = logrr(urkiola, case = 2, nsim = 999, sigma = c(14.5, 15),
                level = 0.95)
save(urkiola_renv, file = "urkiola_renv.rda")

load("urkiola_renv.rda")
# image plot showing regions where r350 is outside
# tolerance envelopes
plot(urkiola_renv)

# a better color scale (in my opinion)
# making it easier to distguish the clusters of cases relative
# to controls (red) and vice versa (blue)
grad = gradient.color.scale(min(urkiola_renv$v, na.rm = TRUE), max(urkiola_renv$v, na.rm = TRUE))
plot(urkiola_renv, col = grad$col, breaks = grad$breaks)


```


