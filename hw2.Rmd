---
title: "Point Processes (Homework 2)"
author: Gregory Matesi
output: 
    pdf_document :
      latex_engine : xelatex
---

```{r}
library(pacman)
p_load(spatstat)
p_load(splancs)
```
# Problem 1.

The spatstat package includes a data set named japanesepines.  The data give 
the locations of Japanese black pine saplings in a square sampling region in a natural 
forest. The observations were originally collected by Numata (1961). 

## a

**Plot the data.  Comment on what you see and whether this looks compatible 
with CSR.**

```{r}
data("japanesepines")

#class(japanesepines)
#?japanesepines
#?ppp.object

plot(japanesepines)
```

I am seeing a seemingly random splatter of data with natural looking clusters of event locations. this looks consistent with Complete Spatial Randomness.

## b

**Estimate and create a contour plot of the intensity function (use Scott’s rule 
for the bandwidth in each direction).  Comment on the plot in relation to 
potential departures from CSR.**

Scott's rule: $\hat{b}_u = \hat{\sigma}_u N^{-1/(dim+4)}$ where $\hat{\sigma}_u$
 is the sample standard deviation of the $u$-coordinates, $N$ is the number of events in the study area, and $dim$ is the dimension of the study aread.
 
$$\hat{b}_u = \hat{\sigma}_u N^{-1/(dim+4)},$$
$$\hat{b}_v = \hat{\sigma}_v N^{-1/(dim+4)}$$
```{r}
sigma_u <- sd(japanesepines[[3]])
sigma_v <- sd(japanesepines[[4]])
dim_uv <- 2
N <- japanesepines[[2]]

bandwidth_u <- sigma_u * N**( -1 / (dim_uv + 4) )
bandwidth_v <- sigma_v * N**( -1 / (dim_uv + 4) )

bandwidth_u_2 <- sd(japanesepines$x) * japanesepines$n ** ( -1 / (dim_uv + 4) )
bandwidth_v_2 <- sd(japanesepines$y) * japanesepines$n ** ( -1 / (dim_uv + 4) )

bandwidth_u; bandwidth_v
bandwidth_u_2 == bandwidth_u; bandwidth_v_2 == bandwidth_v_2
rm(bandwidth_u_2, bandwidth_v_2)
```

```{r}
intensity.function <- density(japanesepines, sigma = c(bandwidth_u, bandwidth_v))
intensity.function
```

```{r}
par(mfrow = c(1, 2))
persp(intensity.function, theta = 45, phi = 35, xlab = "u", ylab = "v", zlab = "density", main = "Estimated intensity function")
contour(intensity.function, xlab = "u", ylab = "v", main = "Japanese Pines", nlevels = 15)
points(japanesepines, pch = ".")
```

## c

**Construct an $\hat{L}(h)-h$ plot for the data with 95% acceptance/non-rejection 
envelopes.  You do not need to specify *r* (the vector of distances) in the 
function—simply use the default values.  What are your conclusions?**

```{r}
lplot <- function(x, nsim = 500, level = 0.95,
                  correction = "Ripley", ...) {
  lobs <- spatstat.core::Lest(x, correction = correction, ...)

  # lambda <- summary(x)$intensity
  win <- x$window
  lsim <- pbapply::pblapply(1:nsim, FUN = function(i) {
    # xsim <- spatstat::rpoispp(lambda, win = win)
    # generate n event locations over study area under CSR
    xsim <- spatstat.core::runifpoint(n = x$n, win = win)
    # estimate L for simulated point pattern
    spatstat.core::Lest(xsim, correction = correction, ...)
  })

  r <- lobs$r # get distances
  obs <- lobs$iso # get estimated l for observed
  # get estimated l for each simulated data set
  sim <- sapply(lsim, getElement, "iso")
  # apply the min function to each row  (MARGIN = 1) of sim
  # gets pointwise minimum for simulated data
  # at each distance.  do same for max, quantiles, median
  lo <- apply(sim, MARGIN = 1, FUN = min, na.rm = TRUE)
  hi <- apply(sim, MARGIN = 1, FUN = max, na.rm = TRUE)
  alpha <- 1 - level
  qlo <- apply(sim, MARGIN = 1, FUN = quantile,
               prob = alpha/2, na.rm = TRUE)
  qhi <- apply(sim, MARGIN = 1, FUN = quantile,
               prob = 1 - alpha/2, na.rm = TRUE)
  med <- apply(sim, MARGIN = 1, FUN = median, na.rm = TRUE)
  # construct empty plot of the right size
  plot(range(r), c(min(c(lo, obs) - r, na.rm = TRUE),
                   max(c(hi, obs) - r, na.rm = TRUE)),
       type = "n",
       xlab = "distance", ylab = "L(distance) - distance")
  # plot different statistics with different styles/thickness
  lines(r, obs - r, lwd = 2)
  lines(r, lo - r, lty = 2)
  lines(r, hi - r, lty = 2)
  lines(r, qlo - r, lty = 1)
  lines(r, qhi - r, lty = 1)
}
```

```{r}
set.seed(1)
lplot(japanesepines, level = .95)
```

# d

**Perform a global test to determine whether there is a departure from CSR in 
the data set at a significance level of 0.05.   In this case, the maximum spatial 
scale to consider (h\*) should be 0.25.  What is your conclusion?**

```{r}

```

# e

**Make conclusions about whether there is evidence of departure from CSR, 
where the departures may occur, and at what scale they may occur based on 
your information from the previous three problem parts.**


# Problem 2

Repeat the analysis from problem 1 for the redwood data in the spatstat package. 
The data represent the locations of 62 seedlings and saplings of California redwood 
trees in a square sampling region. They originate from Strauss (1975); the present 
data are a subset extracted by Ripley (1977) in a subregion that has been rescaled to 
a unit square.  The coordinates are rounded to the nearest 0.01 units, except for one 
point which has an x coordinate of 0.999, presumably to ensure that it is properly 
inside the window. 

# a

```{r}
data("redwood")

```

# Problem 3

The splancs package is another popular (though older) package for statistical 
analysis of spatial point patterns in R.  Reproduce the top panel in Fig 5.13 using the 
splancs package.  The khat and csr functions should come in handy. 